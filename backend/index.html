<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Sign Language Detector</title>

<style>
body { font-family: Arial, sans-serif; background:#f4f7fb; margin:0; }
.container { max-width:1200px; margin:30px auto; display:grid; grid-template-columns:2fr 1fr; gap:20px; }
.card { background:white; border-radius:12px; padding:20px; box-shadow:0 10px 20px rgba(0,0,0,0.08); }
.video-box { height:360px; background:#e5e7eb; border-radius:10px; display:flex; align-items:center; justify-content:center; position:relative; }
video { width:100%; height:100%; object-fit:cover; border-radius:10px; display:none; }
.status { position:absolute; top:10px; right:10px; padding:6px 12px; border-radius:20px; font-size:12px; }
.offline { background:#eee; color:#555; }
.online { background:#d1fae5; color:#065f46; }
textarea { width:100%; height:80px; margin-top:10px; resize:none; padding:10px; font-size:14px; }
button { width:100%; padding:14px; margin-top:10px; border:none; border-radius:8px; font-weight:bold; cursor:pointer; }
.start { background:#14b8a6; color:white; }
.stop { background:#ef4444; color:white; }
.switch { background:#e5e7eb; }
.speak { background:#6366f1; color:white; }
select { width:100%; padding:12px; margin-top:10px; border-radius:8px; }
button:disabled { opacity:0.5; cursor:not-allowed; }
</style>
</head>

<body>

<div class="container">

  <!-- LEFT -->
  <div class="card">
    <h3>Live Feed</h3>
    <div class="video-box">
      <video id="webcam" autoplay playsinline muted></video>
      <div id="placeholder">Camera inactive</div>
      <div id="status" class="status offline">OFFLINE</div>
    </div>

    <h3 style="margin-top:20px;">Detection Output</h3>

    <!-- NOW EDITABLE -->
    <textarea id="sign" placeholder="Recognized sign (you can type here)..."></textarea>

    <textarea id="speech" placeholder="Converted sentence (you can type here)..."></textarea>

    <select id="languageSelect">
      <option value="Tamil" selected>Tamil</option>
      <option value="Malayalam">Malayalam</option>
      <option value="Telugu">Telugu</option>
      <option value="Kannada">Kannada</option>
      <option value="Hindi">Hindi</option>
    </select>

    <button id="speakBtn" class="speak" disabled>ðŸ”Š Speak Sentence</button>
  </div>

  <!-- RIGHT -->
  <div class="card">
    <h3>Control Center</h3>
    <button id="startBtn" class="start">â–¶ Start Detection</button>
    <button id="stopBtn" class="stop" disabled>â–  Stop Detection</button>
    <button id="switchBtn" class="switch" disabled>ðŸ”„ Switch Camera</button>
  </div>

</div>

<video id="processingVideo" autoplay muted playsinline style="display:none;"></video>
<canvas id="canvas" style="display:none;"></canvas>
<audio id="audioPlayer"></audio>

<script>
const PREDICT_URL = "http://localhost:8000/predict";
const SPEAK_URL   = "http://localhost:8000/speak";

let stream = null;
let detecting = false;
let facingMode = "user";
let interval = null;

const webcam = document.getElementById("webcam");
const processingVideo = document.getElementById("processingVideo");
const canvas = document.getElementById("canvas");
const signBox = document.getElementById("sign");
const speechBox = document.getElementById("speech");
const status = document.getElementById("status");
const placeholder = document.getElementById("placeholder");

const startBtn = document.getElementById("startBtn");
const stopBtn = document.getElementById("stopBtn");
const switchBtn = document.getElementById("switchBtn");
const speakBtn = document.getElementById("speakBtn");
const audioPlayer = document.getElementById("audioPlayer");
const languageSelect = document.getElementById("languageSelect");

/* ---------- HELPERS ---------- */
function updateSpeakButton() {
  speakBtn.disabled = speechBox.value.trim().length === 0;
}

/* enable speak when user types */
speechBox.addEventListener("input", updateSpeakButton);

/* ---------- CAMERA ---------- */
async function startCamera() {
  stream = await navigator.mediaDevices.getUserMedia({
    video: { facingMode, width:{ideal:1280}, height:{ideal:720} },
    audio: false
  });

  webcam.srcObject = stream;
  processingVideo.srcObject = stream;

  webcam.style.display = "block";
  placeholder.style.display = "none";
  status.textContent = "LIVE";
  status.className = "status online";
  switchBtn.disabled = false;
}

function stopCamera() {
  if (stream) stream.getTracks().forEach(t => t.stop());
  stream = null;
  webcam.style.display = "none";
  placeholder.style.display = "block";
  status.textContent = "OFFLINE";
  status.className = "status offline";
}

/* ---------- DETECTION ---------- */
function startDetection() {
  if (detecting) return;
  detecting = true;
  startBtn.disabled = true;
  stopBtn.disabled = false;
  interval = setInterval(detectFrame, 300);
}

function stopDetection() {
  detecting = false;
  clearInterval(interval);
  startBtn.disabled = false;
  stopBtn.disabled = true;
}

async function detectFrame() {
  if (processingVideo.readyState !== 4) return;

  canvas.width = processingVideo.videoWidth;
  canvas.height = processingVideo.videoHeight;
  canvas.getContext("2d").drawImage(processingVideo,0,0);

  canvas.toBlob(async blob => {
    if (!blob) return;

    const fd = new FormData();
    fd.append("file", blob, "frame.jpg");

    try {
      const res = await fetch(PREDICT_URL, { method:"POST", body:fd });
      const data = await res.json();

      if (data.prediction) {
        signBox.value = data.prediction;

        const lastWord = speechBox.value.trim().split(" ").pop();
        if (lastWord !== data.prediction) {
          speechBox.value += (speechBox.value ? " " : "") + data.prediction;
        }

        updateSpeakButton();
      }
    } catch (e) {
      console.error("Predict error", e);
    }
  }, "image/jpeg", 0.8);
}

/* ---------- SPEAK ---------- */
speakBtn.onclick = async () => {
  const text = speechBox.value.trim();
  const language = languageSelect.value;
  if (!text) return;

  try {
    speakBtn.disabled = true;
    const res = await fetch(SPEAK_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ text, language })
    });

    const audioBlob = await res.blob();
    audioPlayer.src = URL.createObjectURL(audioBlob);
    audioPlayer.play();
  } catch (e) {
    console.error("Speak error", e);
  } finally {
    speakBtn.disabled = false;
  }
};

/* ---------- EVENTS ---------- */
startBtn.onclick = async () => {
  if (!stream) await startCamera();
  startDetection();
};

stopBtn.onclick = stopDetection;

switchBtn.onclick = async () => {
  facingMode = facingMode === "user" ? "environment" : "user";
  stopCamera();
  await startCamera();
};
</script>

</body>
</html>
